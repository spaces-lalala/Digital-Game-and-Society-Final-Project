<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>元素競技場</title>
    <style>
        body {
            margin: 0;
            height: 100vh;
            display: flex;
            flex-direction: row;
            font-family: Arial, sans-serif;
        }

        #left-panel {
            flex: 3;
            background-color: #f0f0f0;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
        }

        #right-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        #top-right {
            flex: 1;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            padding: 10px;
        }

        #bottom-right {
            flex: 1;
            background-color: #e8e8e8;
        }

        #inventory,
        #craftedCompounds {
            flex: 1;
            background: white;
            border: 2px solid #ccc;
            padding: 10px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin: 10px;
            overflow-y: auto;
            max-height: 250px;
        }

        #inventory h3,
        #craftedCompounds h3 {
            margin: 0 0 10px;
            color: #333;
            font-size: 18px;
            font-weight: bold;
            text-align: center;
            border-bottom: 2px solid #eee;
            padding-bottom: 5px;
        }

        #elementsList,
        #craftedList {
            display: flex;
            flex-direction: column;
            gap: 10px;
            padding: 5px;
        }

        .element-item,
        .compound-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background: #fafafa;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .element-item:hover,
        .compound-item:hover {
            background: #f9f9f9;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
        }

        .delete-compound {
            background: #ff4d4d;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s ease;
        }

        .delete-compound:hover {
            background: #e03c3c;
        }

        #announcement {
            flex: 1;
            background: #fff;
            border: 2px solid #ccc;
            padding: 10px;
            border-radius: 5px;
            margin: 10px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            align-items: stretch;
        }

        #combine-button {
            margin: 20px auto;
            padding: 15px 30px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 18px;
            font-weight: bold;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.15);
            display: block;
            transition: background 0.3s ease, transform 0.2s ease;
        }

        #combine-button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
            box-shadow: none;
        }

        #combine-button:hover:not(:disabled) {
            background-color: #45a049;
            transform: scale(1.05);
        }

        #combine-modal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 300px;
            background: white;
            border: 2px solid #ccc;
            border-radius: 5px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
            z-index: 1000;
            padding: 20px;
            text-align: center;
        }

        #combine-modal h3 {
            margin: 0 0 20px;
        }



        #modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 999;
        }

        canvas {
            background-color: #d0d0d0;
        }

        #health-bar-container {
            position: absolute;
            left: 10px;
            bottom: 10px;
            width: 200px;
            height: 20px;
            background-color: #ccc;
            border: 2px solid #000;
            border-radius: 5px;
            overflow: hidden;
        }

        #health-bar {
            width: 100%;
            height: 100%;
            background-color: #f00;
            transition: width 0.3s ease;
        }

        #player-name-container {
            position: absolute;
            left: 220px;
            /* 血條右邊 */
            bottom: 10px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 14px;
            font-weight: bold;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
        }

        #encyclopedia-modal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 400px;
            background: white;
            border: 2px solid #ccc;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
            z-index: 1001;
            padding: 20px;
            text-align: center;
        }

        #encyclopedia-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
        }

        #modal-content button {
            margin: 10px;
            padding: 10px 20px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
        }

        #modal-content button:hover {
            background-color: #45a049;
        }


        #button-container {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        button {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            color: white;
            font-size: 16px;
        }

        #combine-button {
            background-color: #21f359;
        }

        #speed-button {
            width: 50px;
            height: 50px;
            background-color: #008CBA;
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 14px;
            /* 字體大小縮小 */
            font-weight: bold;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.15);
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 20px auto;
            transition: background 0.3s ease, transform 0.2s ease;
            text-align: center;
        }

        #speed-modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            padding: 20px;
            border-radius: 10px;
            background-color: white;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            display: none;
            z-index: 1000;
        }

        #speed-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: none;
            z-index: 999;
        }

        .speed-option {
            display: block;
            padding: 10px 20px;
            margin: 10px 0;
            background-color: #008CBA;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            text-align: center;
        }





        #skill-button {
            width: 50px;
            height: 50px;
            background-color: #008CBA;
            color: white;
            border: none;
            border-radius: 50%;
            /* 圓形 */
            cursor: not-allowed;
            /* 預設禁用 */
            font-size: 14px;
            /* 字體大小縮小 */
            font-weight: bold;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.15);
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 20px auto;
            transition: background 0.3s ease, transform 0.2s ease;
            text-align: center;
        }

        #skill-button:enabled {
            cursor: pointer;
            background-color: #006494;
        }

        #skill-button:enabled:hover {
            background-color: #004d73;
            transform: scale(1.1);
            /* 放大輕微效果 */
        }

        */
    </style>
</head>

<body>
    <div id="left-panel">
        <canvas id="gameCanvas"></canvas>
        <div id="health-bar-container">
            <div id="health-bar"></div>
        </div>
        <div id="player-name-container">
            <span id="player-name"></span>
        </div>
    </div>
    <div id="right-panel">
        <div id="top-right">
            <div id="inventory">
                <h3>收藏的元素</h3>
                <div id="elementsList"></div>
            </div>
            <div id="craftedCompounds">
                <h3>已製作化合物 <span id="compoundCount">0/2</span></h3>
                <div id="craftedList"></div>
            </div>
        </div>
        <button id="combine-button">化合</button>
        <button id="encyclopedia-button">圖鑑</button>

        <div id="encyclopedia-modal">
            <h3 id="modal-title">圖鑑</h3>
            <div id="modal-content"></div>
            <button id="back-button" style="display: none;">返回</button>
            <button id="close-encyclopedia">關閉</button>
        </div>
        <div id="encyclopedia-overlay"></div>
        <div id="announcement">
            <h3 id="announcement-title">說明欄</h3>
            <p id="announcement-content">
                這邊之後可以放元素教學等等等說明
            </p>
        </div>
    </div>
    <div id="modal-overlay"></div>
    <div id="combine-modal">
        <h3>魔法老奶奶</h3>
        <p>你想製作甚麼呢?</p>
        <div id="current-elements">
            <!-- 顯示當前元素 -->
        </div>
        <div id="compound-buttons"
            style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin: 20px 0;">
            <!-- 化合按鈕 -->
        </div>
        <button id="close-modal">返回</button>
    </div>


    <div id="button-container">
        <button id="speed-button">移動</button>
    </div>

    <div id="speed-overlay"></div>
    <div id="speed-modal">
        <h3>移動概念</h3>
        <button class="speed-option" data-speed="fast">氣體</button>
        <button class="speed-option" data-speed="medium">液體</button>
        <button class="speed-option" data-speed="slow">固體</button>
    </div>


    <!-- <button id="skill-button">技能</button> -->




    <script>
        const canvas = document.getElementById("gameCanvas");
        const ctx = canvas.getContext("2d");
        canvas.width = document.getElementById("left-panel").offsetWidth;
        canvas.height = window.innerHeight;

        const player = { x: 100, y: 100, size: 20, color: "blue", health: 100 };
        const elements = Array.from({ length: 10 }, () => generateRandomElement());
        const projectiles = [];
        const particles = []; // 火焰粒子

        const keysPressed = {}; // 用於追踪按下的按鍵

        const urlParams = new URLSearchParams(window.location.search);
        const playerName = urlParams.get('name') || '未命名玩家';
        document.getElementById("player-name").textContent = playerName;

        const combineButton = document.getElementById("combine-button");
        const combineModal = document.getElementById("combine-modal");
        const modalOverlay = document.getElementById("modal-overlay");
        const closeModal = document.getElementById("close-modal");

        // 定義全域變數
        let craftedCompoundsList = []; // 化合物清單
        let collectedElements = {};    // 收集的元素



        // // 引用按鈕
        // const skillButton = document.getElementById("skill-button");
        // // 初始化技能按鈕為禁用
        // skillButton.disabled = true;




        // 定義技能效果
        const skills = {
            "碳盾": {
                effect: () => {
                    alert("技能啟動！防禦力提升20點！");
                    player.health += 20;
                    if (player.health > 100) player.health = 100; // 最大血量限制
                    updateHealthBar();
                },
            },
            "葡萄糖": {
                effect: () => {
                    alert("技能啟動！立刻恢復生命值 50點！");
                    player.health += 50;
                    if (player.health > 100) player.health = 100; // 最大血量限制
                    updateHealthBar();
                },
            },
            "一氧化二氮": {
                effect: () => {
                    alert("技能啟動！高速移動3秒！");
                    const originalSpeed = 2; // 原始速度
                    const boostedSpeed = 6; // 提升後的速度
                    const duration = 3000; // 持續時間（毫秒）

                    const speedBoostInterval = setInterval(() => {
                        player.x += keysPressed["ArrowRight"] ? boostedSpeed : 0;
                        player.y += keysPressed["ArrowDown"] ? boostedSpeed : 0;
                    }, 100);

                    setTimeout(() => {
                        clearInterval(speedBoostInterval); // 結束加速效果
                        alert("技能效果結束！");
                    }, duration);
                },
            },
        };


        const compounds = {
            "葡萄糖": { formula: { "C": 6, "H": 12, "O": 6 } },
            "蔗糖": { formula: { "C": 12, "H": 22, "O": 11 } },
            "碳盾": { formula: { "C": 3 } },
            "二氧化碳": { formula: { "C": 1, "O": 2 } },
            "醋酸": { formula: { "C": 2, "H": 4, "O": 2 } },
            "一氧化二氮": { formula: { "O": 1, "N": 2 } }
        };

        const compoundDetails = {
            "葡萄糖": {
                description: "最基本的醣類單元，易於吸收，適合作為基礎治療物品。",
                effect: "立刻恢復玩家 20點血量",
                elements: "碳（C）×6 氫（H）×12 氧（O）×6",
                properties: "可快速製造，適合緊急情況下使用。為最基礎的治療物品，不具備額外功能。",
                recipe: "6CO₂ + 6H₂O + 光能 → C₆H₁₂O₆ + 6O₂",
                story: [
                    "哦，魔法師，你來得正好！我聽說你需要些葡萄糖來治癒？別擔心，老婆婆這裡有辦法！",
                    "首先，把你蒐集到的碳、氫、氧元素拿過來。嗯，不錯，數量剛剛好！",
                    "接下來，我們需要一些光能和水。我這裡有秘密藥草，可以穩定反應。別看它不起眼，它可是我祖傳的寶貝！",
                    "好，現在看著我，將這些元素混合在一起，然後施加一點點魔法力量……哈！看到那道光了嗎？反應正在進行！",
                    "完成了！這就是最純淨的葡萄糖。拿去吧，記得小心使用，這可是生命的甘露啊！"
                ]
            },
            "蔗糖": {
                description: "由兩個單醣分子組成，能量密度更高，提供中等程度治療效果。",
                effect: "恢復玩家 40點血量，並在使用後提供 3秒的加速效果（提升移動速度10%）。",
                elements: "單醣×2",
                properties: "製造成本較高，但恢復效果明顯提升，並附帶短暫加速的特殊效果。",
                recipe: "C₆H₁₂O₆ + C₆H₁₂O₆ - H₂O → C₁₂H₂₂O₁₁",
                story: [
                    "哦，你需要蔗糖？這可是能量滿滿的好東西！",
                    "把兩份單醣拿過來，交給我就行了。這可不是簡單的混合，而是需要一點點魔法的幫助。",
                    "現在看好了，我用魔法將兩個單醣分子牽起手來，通過一場特殊的縮合反應...",
                    "看，水分子從它們中間分離出來，它們緊緊相連，變成了蔗糖！",
                    "完成了！這個蔗糖不僅能恢復你的體力，還能讓你跑得更快，記得用它抓住戰鬥的關鍵時刻哦！"
                ]
            },
            "碳盾": {
                description: "由碳（C）製作而成，輕量易得，適合新手使用。",
                effect: "基礎防禦力 +5",
                elements: "碳（C）×3",
                properties: "可升級至更高等級：\n- 等級1（普通）石墨盾：防禦力 +10\n- 等級2（強化）碳納米管盾：防禦力 +20，減少1點酸性傷害\n- 等級3（精煉）金剛石盾：防禦力 +30，耐火效果",
                story: [
                    "哦，年輕人，你需要一面碳盾嗎？別急，我這就幫你製作！",
                    "你知道嗎？碳是一種非常特別的元素，它可以變得又輕又強。",
                    "先拿來三個碳原子，讓我施展排列魔法，把它們編織成六邊形的網格結構...",
                    "看，這種結構既堅固又靈活，像網一樣能擋住攻擊！",
                    "好了！這面碳盾完成了，拿去吧，它能很好地保護你！"
                ]
            },
            "二氧化碳": {
                description: "可產生窒息區域的戰術型物品",
                effect: "傷害值：5，生成「窒息區域」，令敵人在該區域內每秒減少2點血量，持續5秒",
                elements: "碳（C）×1，氧（O）×2",
                properties: "可用於戰術性控制區域",
                recipe: "C + O₂ → CO₂",
                story: [
                    "啊哈，需要製作二氧化碳？這可是個厲害的戰術工具呢！",
                    "快，把一顆碳和兩顆氧拿過來，我來幫你完成反應。",
                    "我們需要高溫來讓它們反應，看著我點燃魔法火焰...哦，看到了嗎？它們開始舞動了！",
                    "這些碳和氧分子正在跳一支華爾滋，它們緊緊相連，變成了二氧化碳！",
                    "完成了！記得小心使用，它可是會讓敵人喘不過氣來的呢！"
                ]
            },
            "醋酸": {
                description: "具有腐蝕性的進攻型物品",
                effect: "傷害值：15，投擲後在地面生成「腐蝕區域」，造成每秒5點傷害，持續3秒",
                elements: "碳（C）×2，氫（H）×4，氧（O）×2",
                properties: "具有持續性傷害效果",
                recipe: "CH₃OH + CO + H₂O → CH₃COOH + H₂",
                story: [
                    "需要醋酸是吧？這東西可得小心，腐蝕性很強呢！",
                    "先把甲醇、一氧化碳和水拿來，我這裡有特殊的魔法容器，不怕它們反應的腐蝕。",
                    "好，把它們放進容器裡，然後加入一點催化劑...噓！別出聲，看著化學反應開始！",
                    "瞧，分子們正在重新排列組合，它們變得越來越活潑了！",
                    "完成了！這就是醋酸，記住，這可是非常強力的攻擊物品哦！"
                ]
            },
            "一氧化二氮": {
                description: "能快速向指定方向位移的特殊化學品。",
                effect: "傷害值：0，特殊功能：向指定方向位移一段距離。",
                elements: "氮（N）×2，氧（O）×1",
                properties: "用於快速移動，適合戰鬥中的靈活應用。",
                recipe: "NH₄NO₃ → N₂O + 2H₂O",
                story: [
                    "啊，年輕人，你需要加速劑嗎？這可是個讓你如風般移動的魔法物品呢！",
                    "首先，拿來硝酸銨。我這裡有個特製的魔法坩堝，專門用來處理這種反應。",
                    "把硝酸銨放進去，然後我會施展火焰魔法...看到了嗎？這些氣泡冒出來了！",
                    "這就是一氧化二氮！它的氣體會像推進器一樣，給你一股強大的衝力！",
                    "好了，這加速劑完成了！記住，使用時要注意方向，別一不小心撞到牆哦！"
                ]
            }
        };

        const maxCompounds = 2;

        combineButton.addEventListener("click", () => {
            combineModal.style.display = "block";
            modalOverlay.style.display = "block";
        });

        closeModal.addEventListener("click", () => {
            combineModal.style.display = "none";
            modalOverlay.style.display = "none";
        });

        modalOverlay.addEventListener("click", () => {
            combineModal.style.display = "none";
            modalOverlay.style.display = "none";
        });

        // 更新化合按鈕事件綁定
        document.getElementById("combine-button").addEventListener("click", () => {
            updateCombineModal();
            document.getElementById("combine-modal").style.display = "block";
            document.getElementById("modal-overlay").style.display = "block";
        });


        function generateRandomElement() {
            const elementTypes = ["lightblue", "aliceblue", "gray", "black", "green"];
            const elementSymbols = { "lightblue": "H", "aliceblue": "O", "gray": "C", "black": "X", "green": "N" };
            const color = elementTypes[Math.floor(Math.random() * elementTypes.length)];
            return {
                x: Math.random() * canvas.width,
                y: Math.random() * canvas.height,
                size: 15,
                color: color,
                symbol: elementSymbols[color],
            };
        }

        function drawPlayer() {
            ctx.fillStyle = player.color;
            ctx.fillRect(player.x, player.y, player.size, player.size);
        }

        function drawElements() {
            elements.forEach(el => {
                ctx.fillStyle = el.color;
                ctx.beginPath();
                ctx.arc(el.x, el.y, el.size, 0, Math.PI * 2);
                ctx.fill();

                // Draw the element symbol at the center of the element
                ctx.fillStyle = "#000";
                ctx.font = "bold 12px Arial";
                ctx.textAlign = "center";
                ctx.textBaseline = "middle";
                ctx.fillText(el.symbol, el.x, el.y);
            });
        }

        function drawProjectiles() {
            projectiles.forEach((proj, index) => {
                ctx.fillStyle = proj.color;
                ctx.beginPath();
                ctx.arc(proj.x, proj.y, proj.size, 0, Math.PI * 2);
                ctx.fill();

                proj.x += proj.vx;
                proj.y += proj.vy;

                if (
                    proj.x < 0 || proj.x > canvas.width ||
                    proj.y < 0 || proj.y > canvas.height
                ) {
                    projectiles.splice(index, 1);
                }
            });
        }

        function createFlameEffect(x, y) {
            for (let i = 0; i < 40; i++) {
                particles.push({
                    x: x,
                    y: y,
                    size: Math.random() * 8 + 4,
                    color: `rgba(255, ${Math.floor(Math.random() * 100 + 100)}, 0, 0.9)`,
                    vx: (Math.random() - 0.5) * 6,
                    vy: (Math.random() - 0.5) * 6,
                    life: 50,
                    alpha: 1,
                });
            }
        }

        function createIceEffect(x, y) {
            for (let i = 0; i < 30; i++) {
                particles.push({
                    x: x,
                    y: y,
                    size: Math.random() * 10 + 5,
                    color: `rgba(173, 216, 230, ${Math.random() * 0.9 + 0.3})`,
                    vx: (Math.random() - 0.5) * 3,
                    vy: (Math.random() - 0.5) * 3,
                    life: 60,
                    alpha: 1,
                });
            }
        }

        function createLightEffect(x, y) {
            for (let i = 0; i < 20; i++) {
                particles.push({
                    x: x,
                    y: y,
                    size: Math.random() * 5 + 2,
                    color: `rgba(255, 255, 0, ${Math.random() * 0.8 + 0.5})`,
                    vx: Math.random() * 8 - 4,
                    vy: Math.random() * 8 - 4,
                    life: 30,
                    alpha: 1,
                });
            }
        }

        function createPoisonEffect(x, y) {
            for (let i = 0; i < 50; i++) {
                particles.push({
                    x: x + (Math.random() - 0.5) * 80,
                    y: y + (Math.random() - 0.5) * 80,
                    size: Math.random() * 5 + 4,
                    color: `rgba(0, 128, 0, ${Math.random() * 0.8 + 0.5})`,
                    vx: (Math.random() - 0.5) * 2,
                    vy: (Math.random() - 0.5) * 2,
                    life: 80,
                    alpha: 1,
                });
            }
        }

        function drawParticles() {
            particles.forEach((particle, index) => {
                ctx.globalAlpha = particle.alpha;
                ctx.fillStyle = particle.color;
                ctx.beginPath();
                ctx.arc(particle.x, particle.y, particle.size, 0, Math.PI * 2);
                ctx.fill();
                ctx.globalAlpha = 1;

                particle.x += particle.vx;
                particle.y += particle.vy;
                particle.alpha -= 0.03;
                particle.size *= 0.95;
                particle.life--;

                if (particle.life <= 0 || particle.alpha <= 0) {
                    particles.splice(index, 1);
                }
            });
        }

        function updateHealthBar() {
            const healthBar = document.getElementById("health-bar");
            healthBar.style.width = `${player.health}%`;

            if (player.health > 50) {
                healthBar.style.backgroundColor = "#0f0";
            } else if (player.health > 20) {
                healthBar.style.backgroundColor = "#ffcc00";
            } else {
                healthBar.style.backgroundColor = "#f00";
            }

            // 偵測血量是否歸零
            if (player.health <= 0) {
                alert("遊戲結束！血量歸零。");
                cancelAnimationFrame(gameLoop); // 停止遊戲循環
            }
        }
        function detectCollision() {
            elements.forEach((el, index) => {
                if (
                    player.x < el.x + el.size &&
                    player.x + player.size > el.x &&
                    player.y < el.y + el.size &&
                    player.y + player.size > el.y
                ) {
                    if (el.color === "black") {
                        player.health -= 20; // 扣除五分之一的血量
                        if (player.health < 0) player.health = 0;
                        updateHealthBar();
                    } else {
                        if (!collectedElements[el.color]) {
                            collectedElements[el.color] = 0;
                        }
                        collectedElements[el.color] += 1;
                        updateInventory();
                    }
                    elements.splice(index, 1);
                }
            });
        }

        function shootProjectile(targetX, targetY) {
            const colors = Object.keys(collectedElements);
            if (colors.length === 0) return;

            const color = colors[0];
            collectedElements[color] -= 1;
            if (collectedElements[color] === 0) {
                delete collectedElements[color];
            }

            const dx = targetX - (player.x + player.size / 2);
            const dy = targetY - (player.y + player.size / 2);
            const length = Math.sqrt(dx * dx + dy * dy);

            projectiles.push({
                x: player.x + player.size / 2,
                y: player.y + player.size / 2,
                size: 10,
                color: color,
                vx: (dx / length) * 5,
                vy: (dy / length) * 5,
            });

            switch (color) {
                case "lightblue":
                    createFlameEffect(player.x + player.size / 2, player.y + player.size / 2);
                    break;
                case "aliceblue":
                    createPoisonEffect(player.x + player.size / 2, player.y + player.size / 2);
                    break;
                case "gray":
                    createLightEffect(player.x + player.size / 2, player.y + player.size / 2);
                    break;
                case "green":
                    createIceEffect(player.x + player.size / 2, player.y + player.size / 2);
                    break;
            }

            updateInventory();
        }

        function updateInventory() {
            const elementsList = document.getElementById("elementsList");
            const craftedList = document.getElementById("craftedList");
            const compoundCount = document.getElementById("compoundCount");

            // 清空現有內容
            elementsList.innerHTML = "";
            craftedList.innerHTML = "";
            compoundCount.textContent = `${craftedCompoundsList.length}/${maxCompounds}`;

            // 更新收集的元素
            const elementSymbols = { "lightblue": "H", "aliceblue": "O", "gray": "C", "black": "X", "green": "N" };
            for (const [color, count] of Object.entries(collectedElements)) {
                const symbol = elementSymbols[color] || "?";

                const elementItem = document.createElement("div");
                elementItem.className = "element-item";
                elementItem.style.display = "flex";
                elementItem.style.justifyContent = "space-between";
                elementItem.style.alignItems = "center";
                elementItem.style.marginBottom = "5px";

                elementItem.innerHTML = `<div>${symbol} x${count}</div>`;
                elementsList.appendChild(elementItem);
            }

            // 更新已製作化合物清單
            craftedCompoundsList.forEach(compound => {
                const compoundItem = document.createElement("div");
                compoundItem.className = "compound-item";
                compoundItem.style.display = "flex";
                compoundItem.style.justifyContent = "space-between";
                compoundItem.style.alignItems = "center";
                compoundItem.style.marginBottom = "10px";

                // 化合物名稱
                const compoundName = document.createElement("div");
                compoundName.textContent = compound;
                compoundItem.appendChild(compoundName);

                // 按鈕容器
                const buttonGroup = document.createElement("div");
                buttonGroup.style.display = "flex";
                buttonGroup.style.gap = "5px";

                // 使用按鈕
                const useButton = document.createElement("button");
                useButton.textContent = "使用";
                useButton.className = "use-compound";
                useButton.style.backgroundColor = "#4CAF50";
                useButton.style.color = "white";
                useButton.style.border = "none";
                useButton.style.padding = "5px 10px";
                useButton.style.borderRadius = "5px";
                useButton.style.cursor = "pointer";

                // 綁定 "使用" 按鈕事件
                useButton.addEventListener("click", () => {
                    useCompound(compound); // 執行技能
                    craftedCompoundsList = craftedCompoundsList.filter(c => c !== compound);
                    updateInventory(); // 更新清單
                });

                // 刪除按鈕
                const deleteButton = document.createElement("button");
                deleteButton.textContent = "刪除";
                deleteButton.className = "delete-compound";
                deleteButton.style.backgroundColor = "#f44336";
                deleteButton.style.color = "white";
                deleteButton.style.border = "none";
                deleteButton.style.padding = "5px 10px";
                deleteButton.style.borderRadius = "5px";
                deleteButton.style.cursor = "pointer";

                // 綁定 "刪除" 按鈕事件
                deleteButton.addEventListener("click", () => {
                    craftedCompoundsList = craftedCompoundsList.filter(c => c !== compound);
                    updateInventory(); // 更新清單
                });

                // 添加按鈕到容器
                buttonGroup.appendChild(useButton);
                buttonGroup.appendChild(deleteButton);

                // 添加按鈕容器到化合物項目
                compoundItem.appendChild(buttonGroup);

                // 添加化合物項目到清單
                craftedList.appendChild(compoundItem);
            });
        }






        canvas.addEventListener("click", (e) => {
            const rect = canvas.getBoundingClientRect();
            const mouseX = e.clientX - rect.left;
            const mouseY = e.clientY - rect.top;
            shootProjectile(mouseX, mouseY);
        });



        // 更新化合視窗內容
        function updateCombineModal() {
            const currentElements = document.getElementById("current-elements");
            const compoundButtons = document.getElementById("compound-buttons");
            const elementSymbols = { "lightblue": "H", "aliceblue": "O", "gray": "C", "black": "X", "green": "N" };

            // 顯示當前元素
            currentElements.innerHTML = "<h4>擁有的元素:</h4>";
            for (const [color, count] of Object.entries(collectedElements)) {
                const symbol = elementSymbols[color];
                currentElements.innerHTML += `<p>${symbol}: ${count}</p>`;
            }

            // 清空按鈕區域
            compoundButtons.innerHTML = "";

            // 動態生成按鈕
            Object.entries(compounds).forEach(([name, { formula }]) => {
                const button = document.createElement("button");
                button.textContent = name;
                button.style.margin = "5px";
                button.style.padding = "8px 15px";
                button.style.borderRadius = "5px";
                button.style.border = "none";
                button.style.cursor = "pointer";

                // 檢查是否有足夠的元素製作
                let canMake = true;
                const missingElements = [];

                Object.entries(formula).forEach(([element, required]) => {
                    // 找到對應顏色的元素
                    const colorKey = Object.entries(elementSymbols).find(([_, symbol]) => symbol === element)?.[0];
                    const available = collectedElements[colorKey] || 0;

                    if (available < required) {
                        canMake = false;
                        missingElements.push(`${element}: 需要${required}個，現有${available}個`);
                    }
                });

                if (canMake) {
                    button.style.backgroundColor = "#4CAF50";
                    button.style.color = "white";
                    button.addEventListener("click", () => {
                        // 創建新的詳細資訊視窗
                        const detailModal = document.createElement("div");
                        detailModal.style.cssText = `
                            position: fixed;
                            top: 50%;
                            left: 50%;
                            transform: translate(-50%, -50%);
                            background: white;
                            padding: 20px;
                            border-radius: 10px;
                            box-shadow: 0 0 10px rgba(0,0,0,0.5);
                            z-index: 1001;
                            min-width: 300px;
                            text-align: center;
                        `;

                        detailModal.innerHTML = `
                            <h3>${name} 詳細資訊</h3>
                            <div id="compound-details">
                                <!-- 這裡會顯示化合物的詳細資訊 -->
                            </div>
                            <button id="confirm-combine" style="
                                background: #4CAF50;
                                color: white;
                                border: none;
                                padding: 8px 15px;
                                border-radius: 5px;
                                margin: 10px;
                                cursor: pointer;
                            ">確認製作</button>
                            <button id="cancel-combine" style="
                                background: #f44336;
                                color: white;
                                border: none;
                                padding: 8px 15px;
                                border-radius: 5px;
                                margin: 10px;
                                cursor: pointer;
                            ">取消</button>
                        `;

                        document.body.appendChild(detailModal);

                        // 更新詳細資訊
                        updateCompoundDetails(name);

                        // 設置確認按鈕事件
                        document.getElementById("confirm-combine").addEventListener("click", () => {
                            // 檢查是否超過限制
                            if (craftedCompoundsList.length >= 2) {
                                alert("最多只能製作兩個化合物！");
                                return;
                            }


                            // 扣除對應元素
                            Object.entries(formula).forEach(([element, required]) => {
                                const colorKey = Object.entries(elementSymbols).find(([_, symbol]) => symbol === element)[0];
                                collectedElements[colorKey] -= required;
                                if (collectedElements[colorKey] <= 0) {
                                    delete collectedElements[colorKey];
                                }
                            });

                            // 顯示魔法老婆婆的對話
                            showGrandmaDialog(name);
                            // 添加化合物至清單
                            craftedCompoundsList.push(name);
                            // 更新顯示
                            updateInventory();
                            updateCombineModal();
                            // 關閉詳細資訊視窗
                            detailModal.remove();
                            // 關閉化合視窗
                            combineModal.style.display = "none";
                            modalOverlay.style.display = "none";
                        });

                        // 設置取消按鈕事件
                        document.getElementById("cancel-combine").addEventListener("click", () => {
                            detailModal.remove();
                        });
                    });
                } else {
                    button.style.backgroundColor = "#ccc";
                    button.style.color = "white";
                    button.title = `無法製作，缺少元素：\n${missingElements.join('\n')}`;
                }

                compoundButtons.appendChild(button);
            });
        }

        function updateCompoundDetails(name) {
            const details = compoundDetails[name];
            const detailsDiv = document.getElementById("compound-details");

            detailsDiv.innerHTML = `
                <div style="text-align: left; margin: 15px; padding: 10px; background: #f5f5f5; border-radius: 5px;">
                    <h4 style="color: #2c3e50; margin-bottom: 10px;">基礎描述：</h4>
                    <p>${details.description}</p>
                    
                    <h4 style="color: #2c3e50; margin-top: 15px;">效果：</h4>
                    <p>${details.effect}</p>
                    
                    <h4 style="color: #2c3e50; margin-top: 15px;">所需元素：</h4>
                    <p>${details.elements}</p>
                    
                    <h4 style="color: #2c3e50; margin-top: 15px;">特性：</h4>
                    <p>${details.properties}</p>
                    
                    ${details.recipe ? `
                        <h4 style="color: #2c3e50; margin-top: 15px;">化學反應式：</h4>
                        <p style="font-family: monospace;">${details.recipe}</p>
                    ` : ''}
                </div>
            `;
        }

        // 魔法老婆婆的對話系統
        function showGrandmaDialog(compound) {
            const stories = compoundDetails[compound].story;
            let currentDialog = 0;

            const dialogBox = document.createElement("div");
            dialogBox.style.cssText = `
                position: fixed;
                bottom: 20%;
                left: 50%;
                transform: translate(-50%, 0);
                background: rgba(255, 255, 255, 0.95);
                padding: 20px;
                border-radius: 10px;
                box-shadow: 0 0 15px rgba(0,0,0,0.3);
                z-index: 1002;
                width: 80%;
                max-width: 600px;
                text-align: center;
                font-family: '微軟正黑體', sans-serif;
            `;

            function updateDialog() {
                if (currentDialog < stories.length) {
                    dialogBox.innerHTML = `
                <div style="display: flex; align-items: center; margin-bottom: 15px;">
                    <img src="./magic-grandma.png" alt="魔法老婆婆" style="width: 50px; height: 50px; border-radius: 50%; margin-right: 15px;">
                    <h3 style="margin: 0; color: #4a4a4a;">魔法老婆婆</h3>
                </div>
                <p style="font-size: 16px; line-height: 1.6; margin: 10px 0;">${stories[currentDialog]}</p>
                <button id="next-dialog" style="
                    background: #4CAF50;
                    color: white;
                    border: none;
                    padding: 8px 20px;
                    border-radius: 5px;
                    cursor: pointer;
                    margin-top: 10px;
                ">繼續</button>
            `;

                    document.getElementById("next-dialog").onclick = () => {
                        currentDialog++;
                        updateDialog();
                    };
                } else {
                    // 對話結束，清除對話框
                    dialogBox.remove();
                    updateInventory();
                    updateCombineModal();
                }
            }

            document.body.appendChild(dialogBox);
            updateDialog();
        }

        const encyclopediaButton = document.getElementById("encyclopedia-button");
        const encyclopediaModal = document.getElementById("encyclopedia-modal");
        const encyclopediaOverlay = document.getElementById("encyclopedia-overlay");
        const closeEncyclopedia = document.getElementById("close-encyclopedia");
        const backButton = document.getElementById("back-button");
        const modalTitle = document.getElementById("modal-title");
        const modalContent = document.getElementById("modal-content");

        const elementsData = {
            "C": "非金屬元素，可形成多樣的化學鍵，構成有機分子的基礎。",
            "O": "極其活潑，能與大部分元素形成化合物，是地球大氣的主要成分。",
            "H": "最輕且最豐富的元素，可形成水和有機分子。",
            "Cl": "鹵素元素，常用於消毒和漂白。",
            "F": "電負性最強，常用於製造冷媒。",
            "S": "廣泛存在於礦物和生物體內，可形成酸性氧化物。",
            "Na": "活潑的鹼金屬，是食鹽的成分。",
            "Hg": "常溫下為液態金屬，具毒性。",
            "Si": "半金屬，用於玻璃、晶片和太陽能電池。",
            "N": "大氣中含量高，能形成高能量化合物。",
            "Au": "貴金屬，具良好的導電性和延展性。",
            "Ag": "貴金屬，抗腐蝕且導電性優異。"
        };

        const compoundsData = {
            "一般化合物": [
                {
                    name: "二氧化碳（CO₂）",
                    damage: 5,
                    effect: "生成「窒息區域」，令敵人在該區域內每秒減少2點血量，持續5秒。",
                    elements: { "碳（C）": 1, "氧（O）": 2 }
                },
                {
                    name: "酒精（乙醇，C₂H₅OH）",
                    damage: 10,
                    effect: "消毒，移除敵人身上的「毒性狀態」。",
                    elements: { "碳（C）": 2, "氫（H）": 6, "氧（O）": 1 }
                },
                {
                    name: "乙酸（醋酸，CH₃COOH）",
                    damage: 15,
                    effect: "生成「腐蝕區域」，每秒10點傷害，持續3秒。",
                    elements: { "碳（C）": 2, "氫（H）": 4, "氧（O）": 2 }
                },
                // 其餘一般化合物...
            ],
            "治療化合物": [
                {
                    name: "單醣（葡萄糖，C₆H₁₂O₆）",
                    restore: 20,
                    effect: "適合作為基礎治療物品。",
                    elements: { "碳（C）": 3, "氫（H）": 6, "氧（O）": 3 }
                },
                {
                    name: "雙醣（蔗糖，C₁₂H₂₂O₁₁）",
                    restore: 40,
                    effect: "提供5秒的加速效果。",
                    elements: { "單醣": 2 }
                },
                {
                    name: "多糖（澱粉或纖維素）",
                    restore: 80,
                    effect: "提供20秒的護盾效果。",
                    elements: { "雙醣": 2 }
                }
            ],
            "護盾化合物": [
                {
                    name: "碳盾（Carbon Shield）",
                    defense: 5,
                    effect: "適合新手使用。",
                    elements: { "碳（C）": 10 }
                },
                {
                    name: "銀盾（Silver Shield）",
                    defense: 15,
                    effect: "毒性傷害減少5%。",
                    elements: { "銀（Ag）": 10 }
                },
                {
                    name: "金盾（Golden Shield）",
                    defense: 30,
                    effect: "減少10%所有元素傷害。",
                    elements: { "金（Au）": 5 }
                }
            ]
        };

        // 打開圖鑑模態視窗
        encyclopediaButton.addEventListener("click", () => {
            encyclopediaModal.style.display = "block";
            encyclopediaOverlay.style.display = "block";
            showMainMenu();
        });

        // 關閉圖鑑模態視窗
        closeEncyclopedia.addEventListener("click", () => {
            encyclopediaModal.style.display = "none";
            encyclopediaOverlay.style.display = "none";
        });

        // 返回上一層
        backButton.addEventListener("click", () => {
            const currentTitle = modalTitle.textContent;

            if (currentTitle === "化合物分類" || currentTitle === "元素") {
                showMainMenu();
            } else if (currentTitle in compoundsData) {
                showCompoundCategories();
            }
        });

        // 主選單
        function showMainMenu() {
            modalTitle.textContent = "圖鑑";
            backButton.style.display = "none";
            modalContent.innerHTML = `
        <button id="elements-button">元素</button>
        <button id="compounds-button">化合物</button>
    `;

            document.getElementById("elements-button").addEventListener("click", () => {
                showElements();
            });

            document.getElementById("compounds-button").addEventListener("click", () => {
                showCompoundCategories();
            });
        }

        // 顯示元素列表
        function showElements() {
            modalTitle.textContent = "元素";
            backButton.style.display = "block";
            modalContent.innerHTML = "<h4>選擇元素查看詳情</h4>";

            Object.entries(elementsData).forEach(([symbol, description]) => {
                const button = document.createElement("button");
                button.textContent = symbol;
                button.style.margin = "5px";
                button.addEventListener("click", () => {
                    modalContent.innerHTML = `<h4>${symbol}</h4><p>${description}</p>`;
                });
                modalContent.appendChild(button);
            });
        }

        // 顯示化合物分類
        function showCompoundCategories() {
            modalTitle.textContent = "化合物分類";
            backButton.style.display = "block";
            modalContent.innerHTML = `
        <button data-category="一般化合物">一般化合物</button>
        <button data-category="治療化合物">治療化合物</button>
        <button data-category="護盾化合物">護盾化合物</button>
    `;

            modalContent.querySelectorAll("button").forEach(button => {
                button.addEventListener("click", () => {
                    const category = button.dataset.category;
                    showCompoundDetails(category);
                });
            });
        }

        // 顯示化合物詳細內容
        function showCompoundDetails(category) {
            modalTitle.textContent = category;
            backButton.style.display = "block";
            modalContent.innerHTML = compoundsData[category]
                .map(compound => `
            <div style="margin-bottom: 10px; text-align: left;">
                <h4>${compound.name}</h4>
                <p>傷害值：${compound.damage || "—"}</p>
                <p>效果：${compound.effect}</p>
                <p>所需元素：${Object.entries(compound.elements)
                        .map(([element, count]) => `${element} ×${count}`)
                        .join(", ")}</p>
            </div>
        `)
                .join("");
        }
        // 化合按鈕事件綁定
        combineButton.addEventListener("click", () => {
            updateCombineModal();
            combineModal.style.display = "block";
            modalOverlay.style.display = "block";
        });



        // 更新技能按鈕狀態
        // function updateSkillButton() {
        //     // 啟用按鈕條件：至少有一個化合物
        //     skillButton.disabled = craftedCompoundsList.length === 0;
        //     if (skillButton.disabled) {
        //         skillButton.style.cursor = "not-allowed";
        //         skillButton.style.backgroundColor = "#ccc"; // 禁用樣式
        //     } else {
        //         skillButton.style.cursor = "pointer";
        //         skillButton.style.backgroundColor = "#006494"; // 啟用樣式
        //     }
        // }


        // 綁定技能按鈕事件
        // skillButton.addEventListener("click", () => {
        //     if (craftedCompoundsList.length > 0) {
        //         // 使用第一個化合物作為示例
        //         const selectedCompound = craftedCompoundsList[0];

        //         if (skills[selectedCompound]) {
        //             // 執行技能效果
        //             skills[selectedCompound].effect();

        //             // 從清單中移除該化合物
        //             craftedCompoundsList.shift();

        //             // 更新介面
        //             updateCraftedCompounds();
        //             updateSkillButton();
        //         } else {
        //             alert("該化合物無法觸發技能！");
        //         }
        //     } else {
        //         alert("沒有可用的化合物！");
        //     }
        // });


        // 更新合成按鈕狀態的函數
        function updateCombineButton() {
            const combineButton = document.getElementById("combine-button");
            combineButton.disabled = craftedCompoundsList.length >= maxCompounds;
        }

        // 更新已製作化合物顯示
        // 更新 updateCraftedCompounds 函數
        function updateCraftedCompounds() {
            const craftedList = document.getElementById("craftedList");
            const compoundCount = document.getElementById("compoundCount");

            // 清空化合物清單
            craftedList.innerHTML = "";
            compoundCount.textContent = `${craftedCompoundsList.length}/${maxCompounds}`;

            // 為每個化合物生成對應的項目
            craftedCompoundsList.forEach(compound => {
                const compoundItem = document.createElement("div");
                compoundItem.className = "compound-item";
                compoundItem.style.display = "flex";
                compoundItem.style.justifyContent = "space-between";
                compoundItem.style.alignItems = "center";
                compoundItem.style.marginBottom = "10px";

                // 化合物名稱
                const compoundName = document.createElement("div");
                compoundName.textContent = compound;
                compoundItem.appendChild(compoundName);

                // 按鈕容器
                const buttonGroup = document.createElement("div");
                buttonGroup.style.display = "flex";
                buttonGroup.style.gap = "5px";

                // 使用按鈕
                const useButton = document.createElement("button");
                useButton.textContent = "使用";
                useButton.className = "use-compound";
                useButton.style.backgroundColor = "#4CAF50";
                useButton.style.color = "white";
                useButton.style.border = "none";
                useButton.style.padding = "5px 10px";
                useButton.style.borderRadius = "5px";
                useButton.style.cursor = "pointer";

                // 使用按鈕事件綁定
                useButton.addEventListener("click", () => {
                    useCompound(compound); // 執行技能
                    craftedCompoundsList = craftedCompoundsList.filter(c => c !== compound);
                    updateCraftedCompounds();
                    // updateSkillButton();
                });

                // 刪除按鈕
                const deleteButton = document.createElement("button");
                deleteButton.textContent = "刪除";
                deleteButton.className = "delete-compound";
                deleteButton.style.backgroundColor = "#f44336";
                deleteButton.style.color = "white";
                deleteButton.style.border = "none";
                deleteButton.style.padding = "5px 10px";
                deleteButton.style.borderRadius = "5px";
                deleteButton.style.cursor = "pointer";

                // 刪除按鈕事件綁定
                deleteButton.addEventListener("click", () => {
                    craftedCompoundsList = craftedCompoundsList.filter(c => c !== compound);
                    updateCraftedCompounds();
                    // updateSkillButton();
                });

                // 添加按鈕到容器
                buttonGroup.appendChild(useButton);
                buttonGroup.appendChild(deleteButton);

                // 添加按鈕容器到化合物項目
                compoundItem.appendChild(buttonGroup);

                // 添加化合物項目到清單
                craftedList.appendChild(compoundItem);
            });

        }

        function AcidSkillEffect(x, y) {
            for (let i = 0; i < 50; i++) {
                particles.push({
                    x: x + (Math.random() - 0.5) * 80,
                    y: y + (Math.random() - 0.5) * 80,
                    size: Math.random() * 300 + 4,
                    color: `rgba(0, 128, 0, ${Math.random() * 0.8 + 0.5})`,
                    vx: (Math.random() - 0.5) * 2,
                    vy: (Math.random() - 0.5) * 2,
                    life: 80,
                    alpha: 1,
                });
            }
        }

        function Co2SkillEffect(x, y) {
            for (let i = 0; i < 20; i++) {
                particles.push({
                    x: x,
                    y: y,
                    size: Math.random() * 300 + 2,
                    color: `rgba(128, 128, 128, ${Math.random() * 0.8 + 0.5})`,
                    vx: Math.random() * 8 - 4,
                    vy: Math.random() * 8 - 4,
                    life: 30,
                    alpha: 1,
                });
            }
        }


        // 使用化合物的函數
        function useCompound(compound) {
            switch (compound) {
                case "二氧化碳":
                    Co2SkillEffect(player.x, player.y);
                    break;
                case "醋酸":
                    AcidSkillEffect(player.x, player.y);
                    break;
                case "蔗糖":
                    player.health = Math.min(100, player.health + 40);
                    updateHealthBar();
                    createLightEffect(player.x, player.y);
                    break;
                case "葡萄糖":
                    player.health = Math.min(100, player.health + 20);
                    updateHealthBar();
                    createLightEffect(player.x, player.y);
                    break;
                case "碳盾":
                    createIceEffect(player.x, player.y);
                    player.health = Math.min(100, player.health + 20);
                    break;
                case "一氧化二氮":
                    createIceEffect(player.x, player.y);
                    const boostedSpeed = 6;
                    const duration = 3000;

                    const speedBoostInterval = setInterval(() => {
                        if (keysPressed["ArrowRight"]) player.x += boostedSpeed;
                        if (keysPressed["ArrowLeft"]) player.x -= boostedSpeed;
                        if (keysPressed["ArrowUp"]) player.y -= boostedSpeed;
                        if (keysPressed["ArrowDown"]) player.y += boostedSpeed;
                    }, 16);

                    setTimeout(() => {
                        clearInterval(speedBoostInterval);
                    }, duration);

                    break;
                default:
                    alert("未知的化合物效果");
            }
        }



        // 同步更新狀態
        updateCraftedCompounds();
        updateCombineButton();
        // updateSkillButton();


        let step = 2; 
        // 選取 DOM 元素
        const speedButton = document.getElementById("speed-button");
        const speedModal = document.getElementById("speed-modal");
        const speedOverlay = document.getElementById("speed-overlay");
        const speedOptions = document.querySelectorAll(".speed-option");

        // 打開速度選單
        speedButton.addEventListener("click", () => {
            speedModal.style.display = "block";
            speedOverlay.style.display = "block";
        });

        // 關閉速度選單
        speedOverlay.addEventListener("click", () => {
            speedModal.style.display = "none";
            speedOverlay.style.display = "none";
        });

        // 處理速度選擇
        speedOptions.forEach(option => {
            option.addEventListener("click", (e) => {
                const speed = e.target.getAttribute("data-speed");
                switch (speed) {
                    case "fast":
                        step = 4;
                        break;
                    case "medium":
                        step = 3;
                        break;
                    case "slow":
                        step = 2;
                        break;
                    default:
                        alert("未知速度選項");
                }
                speedModal.style.display = "none"; // 關閉選單
                speedOverlay.style.display = "none"; // 隱藏覆蓋層
            });
        });

        function gameLoop() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            drawPlayer();
            drawElements();
            drawProjectiles();
            drawParticles();
            detectCollision();


            if (keysPressed["ArrowUp"] && player.y > 0) {
                player.y -= step;
            }
            if (keysPressed["ArrowDown"] && player.y + player.size < canvas.height) {
                player.y += step;
            }
            if (keysPressed["ArrowLeft"] && player.x > 0) {
                player.x -= step;
            }
            if (keysPressed["ArrowRight"] && player.x + player.size < canvas.width) {
                player.x += step;
            }

            requestAnimationFrame(gameLoop);
        }



        document.addEventListener("keydown", (e) => {
            keysPressed[e.key] = true;
        });

        document.addEventListener("keyup", (e) => {
            keysPressed[e.key] = false;
        });

        setInterval(() => {
            elements.push(generateRandomElement());
        }, 10000);

        gameLoop();
    </script>
</body>

</html>